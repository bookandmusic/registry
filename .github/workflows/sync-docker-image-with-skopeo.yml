name: Multi-Arch Image Replication to GHCR with Skopeo

on:
  workflow_dispatch:
    inputs:
      source_image:
        description: 'Docker Hub é•œåƒåç§° (ä¾‹å¦‚: nginx æˆ– library/nginx)'
        required: true
        default: 'nginx'
      source_tag:
        description: 'Docker Hub é•œåƒæ ‡ç­¾ (ä¾‹å¦‚: 1.25.1)'
        required: true
        default: 'latest'

jobs:
  replicate:
    permissions:
      contents: read
      packages: write
    runs-on: ubuntu-latest

    steps:
      - name: Set Variables
        id: vars
        run: |
          # å¤„ç†æºé•œåƒåç§°ï¼ˆDocker Hubï¼‰
          SOURCE_IMAGE_INPUT="${{ github.event.inputs.source_image }}"
          
          if [[ "$SOURCE_IMAGE_INPUT" != *"/"* ]]; then
            SOURCE_IMAGE_FULL="library/$SOURCE_IMAGE_INPUT"
          else
            SOURCE_IMAGE_FULL="$SOURCE_IMAGE_INPUT"
          fi
          
          IMAGE_NAME=$(echo "$SOURCE_IMAGE_FULL" | awk -F '/' '{print $NF}')
          TARGET_IMAGE="ghcr.io/${{ github.actor }}/$IMAGE_NAME"
          SOURCE_TAG="${{ github.event.inputs.source_tag }}"
          TARGET_TAG="$SOURCE_TAG"
          
          if [ -z "$TARGET_TAG" ]; then
            TARGET_TAG="latest"
          fi

          echo "SOURCE_IMAGE=docker.io/$SOURCE_IMAGE_FULL" >> $GITHUB_OUTPUT
          echo "TARGET_IMAGE=$TARGET_IMAGE" >> $GITHUB_OUTPUT
          echo "SOURCE_TAG=$SOURCE_TAG" >> $GITHUB_OUTPUT
          echo "TARGET_TAG=$TARGET_TAG" >> $GITHUB_OUTPUT

      - name: Install Skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | skopeo login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Sync Multi-Arch Image with --all
        run: |
          SOURCE_IMAGE="${{ steps.vars.outputs.SOURCE_IMAGE }}"
          TARGET_IMAGE="${{ steps.vars.outputs.TARGET_IMAGE }}"
          SOURCE_TAG="${{ steps.vars.outputs.SOURCE_TAG }}"
          TARGET_TAG="${{ steps.vars.outputs.TARGET_TAG }}"
          
          echo "ğŸ”„ åŒæ­¥å¤šæ¶æ„é•œåƒï¼ˆæ‰€æœ‰æ¶æ„ï¼‰..."
          echo "æºé•œåƒ: $SOURCE_IMAGE:$SOURCE_TAG"
          echo "ç›®æ ‡é•œåƒ: $TARGET_IMAGE:$TARGET_TAG"
          
          # ä½¿ç”¨ --all å‚æ•°åŒæ­¥æ‰€æœ‰æ¶æ„
          skopeo copy \
            --src-tls-verify=false \
            --dest-tls-verify=false \
            --all \
            "docker://$SOURCE_IMAGE:$SOURCE_TAG" \
            "docker://$TARGET_IMAGE:$TARGET_TAG"
          
          echo "âœ… å¤šæ¶æ„é•œåƒåŒæ­¥å®Œæˆ"
